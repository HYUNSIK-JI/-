{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block body %}
<div class="container">
    {{review.keyboard.name}}
    <h5 class="hits">조회수 :
    {{ review.hits }}
    </h5>
    <h1>
    리뷰
    </h1>

    <li>{{ review.user }}</li>
    <li>{{ review.created_at }}</li>

    <li>평점:
    {{ review.grade }}</li>
    <hr>
    <h1 class='text-center'>{{ review.title }}</h1>
    <p>{{ review.content }}
    <p>
        {% if review.img %}
        <div class='text-center'>
            <img src="{{ review.img.url }}" alt="{{ review.img }}">
        </div>
        {% endif %}
        <!--좋아요-->
        <div class="heart d-flex align-items-end">
        {% if request.user.is_authenticated %}
            {% if request.user not in review.like_users.all %}
            <i data-like-id="{{ review.pk }}" id="like-btn" class="bi bi-heart"></i>
            {% else %}
            <i data-like-id="{{ review.pk }}" id="like-btn" class="bi bi-heart-fill"></i>
            {% endif %}
        {% endif %}
        <h6 class="likes text-muted">|
            {{ review.like_users.count }}명이 이 글을 좋아해요</h6>
        </div>
        <!--즐겨찾기(bookmark)-->
        <div class="d-flex align-items-center">
        {% if request.user.is_authenticated %}
            {% if request.user not in review.bookmark_users.all %}
            <i data-bookmark-id="{{ review.pk }}" id="bookmark-btn" class="bi bi-bookmark-check"></i>
            {% else %}
            <i data-bookmark-id="{{ review.pk }}" id="bookmark-btn" class="bi bi-bookmark-check-fill"></i>
            {% endif %}
        {% endif %}
        </div>
        <!--리뷰 수정,삭제 버튼-->
        <div>
        {% if request.user == review.user %}
            <div class='d-grid gap-2 my-4'>
            <a class='btn btn-outline-success btn-sm' href="{% url 'reviews:update' review.pk %}">수정하기</a>
            <a class='btn btn-outline-danger btn-sm' href="{% url 'reviews:delete' review.pk %}">삭제하기</a>
            </div>
        {% endif %}
        </div>
        <div>
        <h3 class='text-center'>댓글 목록</h3>
        </div>
        <div>
        {% if request.user.is_authenticated %}
            <form id="comment-form" data-review-id="{{ review.pk }}" action="{%url 'reviews:comment_create' review.pk %}" method="POST">
            {% csrf_token %}
            {% bootstrap_form comment_form %}
            <input class="btn btn-success" type="submit" value="제출">
            </form>
        {% endif %}
        </div>
        <hr>
        <div id="comments">
        {% for comment in comments %}
            <hr>
        <p>{{comment.user}} | {{comment.content}} | {{ comment.created_at }}</p>
            {% if request.user not in comment.like_users.all %}
              <i class="bi bi-heart" onclick="likecomment(this)" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}" id="commentlike"></i>
            {% else %}
              <i class="bi bi-heart-fill" onclick="likecomment(this)" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}" id="commentlike"></i>
            {% endif %}
            {% if request.user == comment.user %}
            <button class="btn btn-outline-danger comment" onclick="delete_comment(this)" id="comment-delete-{{ comment.pk }}" data-reviewdel-id="{{ review.pk }}" data-commentdel-id="{{ comment.pk }}">삭제</button>
            {% endif %}
        {% endfor %}
        </div>
        

    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        //좋아요 비동기
        const likeBtn = document.querySelector('#like-btn')
        likeBtn.addEventListener('click', function (event) {
        console.log(event.target.dataset)
        axios({method: 'get', url: `/reviews/${event.target.dataset.likeId}/like/`}).then(response => {
            console.log(response.data)
            if (response.data.isLike === true) {
            event
                .target
                .classList
                .add('bi-heart-fill')
            event
                .target
                .classList
                .remove('bi-heart')
            // console.log('좋아요')
            } else {
            event
                .target
                .classList
                .add('bi-heart')
            event
                .target
                .classList
                .remove('bi-heart-fill')
            // console.log('좋아요아님')
            }
            const likeCount = document.querySelector('.likes')
            likeCount.innerHTML = `<h6 class="likes m-0 text-muted ">| ${response.data.likeCount}명이 이 글을 좋아해요</h6>`
        })
        })
    </script>
    <script>
        // 댓글 좋아요 비동기

        const likecomment = (e) => {
          const comment_id = document
            .querySelector(`#${e.id}`)
            .id;
          axios({method: 'get', url: `/reviews/${event.target.dataset.reviewId}/like/${event.target.dataset.commentId}`}).then(response => {
            console.log(response)
            if (response.data.isLike === true) {
              e.classList.add('bi-heart-fill')
              e.classList.remove('bi-heart')
            // console.log('좋아요')
            } else {
              e.classList.add('bi-heart')
              e.classList.remove('bi-heart-fill')
            // console.log('좋아요아님')
            }

          })
        }
      </script>
      <script>
        // 비동기 북마크
        const bookmarkBtn = document.querySelector('#bookmark-btn')
        // querySelector(#bookmark-btn) => id 값 bookmark-btn를 가진 요소를 찾습니다.
        bookmarkBtn.addEventListener('click', function (event) {
        console.log(event.target.dataset)
        // 버튼 클릭 시, e라는 함수 이벤트가 발생. dataset을 불러옴.
        axios({method: 'get', url: `/reviews/${event.target.dataset.bookmarkId}/bookmark/`}).then(response => {
            console.log(response.data)
            if (response.data.isBookmark === true) {
            // isBookmark = context에서 선언해준 isBookmark
            event
                .target
                .classList
                .add('bi-bookmark-check-fill')
            event
                .target
                .classList
                .remove('bi-bookmark-check')
            console.log('관심찜')
            } else {
            event
                .target
                .classList
                .remove('bi-bookmark-check-fill')
            event
                .target
                .classList
                .add('bi-bookmark-check')
            console.log('관심없음')
            }
        })
        })
    </script>
    <script>
        //댓글 생성 비동기
        const commentForm = document.querySelector('#comment-form')
        const csrftoken = document
        .querySelector('[name=csrfmiddlewaretoken]')
        .value

        commentForm
        .addEventListener('submit', function (event) {
            event.preventDefault();
            axios({
            method: 'post',
            url: `/reviews/${event.target.dataset.reviewId}/comment_create/`,
            headers: {
                'X-CSRFToken': csrftoken
            },
            data: new FormData(commentForm)
            })
            .then(response => {
                console.log(response)
                const comments = document.querySelector('#comments')
                comments.textContent = "";
                const hr = document.createElement('hr')
                const comment_data = response.data.comment_data

                const user = response.data.user
                for (let i = 0; i < comment_data.length; i++) {
                  const review_pk = response.data.review_pk
                    console.log(comment_data[i].id, user)
                    if (user === comment_data[i].id) {
                      if (comment_data[i].islike) {
                        comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                          <button class="btn btn-outline-danger comment" onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-reviewdel-id="${review_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                        </div>
                        `);
                      } else {
                        comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart-fill" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                          <button class="btn btn-outline-danger comment" onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-reviewdel-id="${review_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                        </div>
                        `);
                      }
                    } else {
                      if (comment_data[i].islike) {
                        comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                        <hr>
                        <i class="bi bi-heart" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                        <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                        </div>
                        `);
                      } else {
                        comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart-fill" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                        </div>
                        `);
                      }
                    }
                }
                commentForm
                .reset()
            })
            .catch(console.log(1))
            })
    </script>
    <script>
        // 댓글 삭제 비동기
        const delete_comment = (e) => {
        const comment_id = document
            .querySelector(`#${e.id}`)
            .id;
        axios({
            method: 'post',
            url: `/reviews/${event.target.dataset.reviewdelId}/comment_delete/${event.target.dataset.commentdelId}/delete/`,
            headers: {
            'X-CSRFToken': csrftoken
            }
        }).then(response => {
            console.log(response)
            const comments = document.querySelector('#comments')
            comments.textContent = "";
            const hr = document.createElement('hr')
            const comment_data = response.data.comment_data
            const user = response.data.user
            for (let i = 0; i < comment_data.length; i++) {
              const review_pk = response.data.review_pk
                console.log(comment_data[i].id, user)
              if (user === comment_data[i].id) {
                if (comment_data[i].islike) {
                  comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                          <button class="btn btn-outline-danger comment" onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-reviewdel-id="${review_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                        </div>
                        `);
                } else {
                  comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart-fill" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                          <button class="btn btn-outline-danger comment" onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-reviewdel-id="${review_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                        </div>
                        `);
                }
              } else {
                if (comment_data[i].islike) {
                  comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                        <hr>
                        <i class="bi bi-heart" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                        <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                        </div>
                        `);
                } else {
                  comments.insertAdjacentHTML('beforeend', `
                        <div id="comments">
                          <hr>
                          <i class="bi bi-heart-fill" onclick="likecomment(this)" data-review-id="${review_pk}" data-comment-id="${comment_data[i].commentPk}" id="commentlike"></i>
                          <p>${comment_data[i].userName} | ${comment_data[i].content} | ${comment_data[i].created_at}</p>
                        </div>
                        `);
                }
              }
            }
            }
        })
        }
    </script>
    {% endblock body %}
