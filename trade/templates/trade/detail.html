{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}

{% block body %}
<div class='trade-all'>
  <div class="keyboard-detail-all">
    <div class="keyboard-detail-img-wrap">
      <img src="{{ photos.0.image.url }}">
    </div>
    <!-- 제품정보 -->
    <div class="keyboard-detail-content">
      <div class="trade-keyboard-name">
        <h2>{{ trade.title }}</h2>
        <div>
          <i class="bi bi-bookmark-fill"></i>
          <span id="marker_count">{{trade.marker.all.count}}</span>
        </div>
      </div>
      <table>
        <tr>
          <th>매도/매수</th>
          <td>{%if trade.Trade_type == 1%}판매{%else%}구매{%endif%}</td>
        </tr>
        <tr>
          <th>모델명</th>
          <td>{{ trade.keyboard.name }}</td>
        </tr>
        <tr>
          <th>별점</th>
          <td id="keyboard-star">☆☆☆☆</td>
        </tr>
        <tr>
          <th>제조사</th>
          <td>{{ trade.keyboard.brand }}</td>
        </tr>
        {% if trade.keyboard.connect != '기타' %}
        <tr>
          <th>연결 방식</th>
          <td>{{ trade.keyboard.connect }}</td>
        </tr>
        {% endif %}
        {% if trade.keyboard.switch != '기타' %}
        <tr>
          <th>스위치</th>
          <td>{{ trade.keyboard.switch }}</td>
        </tr>
        {% endif %}
        {% if trade.keyboard.key_switch != '기타' %}
        <tr>
          <th>키 스위치</th>
          <td>{{ trade.keyboard.key_switch }}</td>
        </tr>
        {% endif %}
        {% if trade.keyboard.press != '기타' %}
        <tr>
          <th>키압</th>
          <td>{{ trade.keyboard.press }}</td>
        </tr>
        {% endif %}
        <tr>
          <th>키 배열</th>
          <td>{{ trade.keyboard.kind }} / {{ trade.keyboard.array }}키 </td>
        </tr>
        <tr>
          <th>무게</th>
          <td>{{ trade.keyboard.weight }}</td>
        </tr>
      </table>

      {% if request.user != trade.user %}
        <div class="jjimjjok">
          {% if request.user in trade.marker.all %}
          <div class="trade-detail-btn jjim" id="marker-icon" data-trade-id="{{ trade.pk }}">
            <i class="bi bi-bookmark-fill" data-trade-id="{{ trade.pk }}"></i>
            <span data-trade-id="{{ trade.pk }}">찜완료</span>
          </div>
          {% else %}
          <div class="trade-detail-btn no-jjim" id="marker-icon" data-trade-id="{{ trade.pk }}">
            <i class="bi bi-bookmark" id="bookmark" data-trade-id="{{ trade.pk }}"></i>
            <span data-trade-id="{{ trade.pk }}">찜하기</span>
          </div>
          {% endif %}
          <div class="trade-detail-btn jjok">쪽지보내기</div>
        </div>
      {% endif %}

      <div class='trade-content'>
        {{ trade.content }}
      </div>

      <div class="keyboard-detail-mini-1">
        <div class="keyboard-detail-mini-1-title">
          <h2>이 키보드의 사용자의 경험 알아보기</h2>
          <a class="a-blue" href='#'>알아보기 ></a>
        </div>
      </div>
    </div>
  </div>

  
</div>




      





<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const commentFrom = document.querySelector('#commentForm')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    commentFrom.addEventListener('submit', function (event) {
        event.preventDefault();
        axios({
            method: 'post',
            url: `/trade/${event.target.dataset.tradeId}/comment/`,
            header: { 'X-CSRFtoken': csrftoken },
            data: new FormData(commentFrom)
        })
            .then(response => {
                const comment_box = document.querySelector('#comment_box')
                const user = response.data.user
                comment_box.textContent = "";
                const comment_list = response.data.comment_list
                for (let i = 0; i < comment_list.length; i++) {
                    if (user === comment_list[i].pk) {
                        console.log(comment_list[i])
                        comment_box.insertAdjacentHTML('beforeend', `
                    <hr>
                    <p>${comment_list[i].content}<span> | ${comment_list[i].user}</span></p>
                    <button id="delete_btn_${comment_list[i].comment_pk}" onclick="delete_btn()" data-trade-id="{{trade.pk}}" data-comment-id= "${comment_list[i].comment_pk}"> 삭제하기 </button>
                    </div>`);
                        console.log("댓글 전송 ")
                    } else {
                        console.log(comment_list[i])
                        comment_box.insertAdjacentHTML('beforeend', `
                    <hr>
                    <p>${comment_list[i].content}<span> | ${comment_list[i].user}</span></p>`);
                    }

                }
                commentFrom.reset()
                console.log("코멘트 전송")
            })
    })

</script>

<!-- 비동기 댓글 삭제  -->
<script>
    const delete_btn = (e) => {
        const delete_data = document.querySelector(`#delete_btn_${event.target.dataset.commentId}`)
        console.log("댓글삭제시행")
        event.preventDefault();
        axios({
            method: 'get',
            url: `/trade/${event.target.dataset.tradeId}/${event.target.dataset.commentId}/comment_delete/`,
        })
            .then(response => {

                const comment_box = document.querySelector('#comment_box')
                const user = response.data.user
                const p = document.createElement('p')
                const hr = document.createElement('hr')
                comment_box.textContent = "";
                const comment_list = response.data.comment_list
                for (let i = 0; i < comment_list.length; i++) {
                    if (user === comment_list[i].pk) {
                        console.log(comment_list[i])
                        comment_box.insertAdjacentHTML('beforeend', `
                    <hr>
                    <p>${comment_list[i].content}<span> | ${comment_list[i].user}</span></p>
                    <button id="delete_btn_${comment_list[i].comment_pk}" onclick="delete_btn()" data-trade-id="{{trade.pk}}" data-comment-id= "${comment_list[i].comment_pk}"> 삭제하기 </button>
                    </div>`);
                        console.log(" ")
                    } else {
                        console.log(comment_list[i])
                        comment_box.insertAdjacentHTML('beforeend', `
                    <hr>
                    <p>${comment_list[i].content}<span> | ${comment_list[i].user}</span></p>`);
                    }

                }

                console.log("")
            })
    }

</script>

<!-- 찜하기 스크립트!! -->

<script>
    const marker = document.querySelector('#marker-icon')
    const marker_text_wrap = marker.querySelector('div')
    marker.addEventListener('click', function (event) {
        capture:true
        axios({
            method: 'get',
            url: `/trade/${event.target.dataset.tradeId}/marker/`
        })
            .then(response => {

                console.log(response)
                console.log(response.data)
                if (response.data.is_marker === true) {
                  marker.classList.add('jjim')
                  marker.classList.remove('no-jjim')
                  marker.querySelector('span').innerText = '찜완료'
                  marker.querySelector('#bookmark').classList.add('bi-bookmark-fill')
                  marker.querySelector('#bookmark').classList.remove('bi-bookmark')
                } else {
                  marker.classList.add('no-jjim')
                  marker.classList.remove('jjim')
                  marker.querySelector('span').innerText = '찜하기'
                  marker.querySelector('#bookmark').classList.add('bi-bookmark')
                  marker.querySelector('#bookmark').classList.remove('bi-bookmark-fill')
                }
                const marker_count = document.querySelector('#marker_count')
                marker_count.innerText = response.data.markers

            })
    })
</script>



{% endblock body %}